Component({properties:{imgSrc:{type:String},height:{type:Number,value:200},width:{type:Number,value:200},min_width:{type:Number,value:100},min_height:{type:Number,value:100},max_width:{type:Number,value:300},max_height:{type:Number,value:300},disable_width:{type:Boolean,value:!1},disable_height:{type:Boolean,value:!1},disable_ratio:{type:Boolean,value:!1},export_scale:{type:Number,value:3},quality:{type:Number,value:1},cut_top:{type:Number,value:null},cut_left:{type:Number,value:null},canvas_top:{type:Number,value:null},canvas_left:{type:Number,value:null},img_width:{type:null,value:null},img_height:{type:null,value:null},scale:{type:Number,value:1},angle:{type:Number,value:0},min_scale:{type:Number,value:.5},max_scale:{type:Number,value:2},disable_rotate:{type:Boolean,value:!1},limit_move:{type:Boolean,value:!1}},data:{el:"image-cropper",info:wx.getSystemInfoSync(),MOVE_THROTTLE:null,MOVE_THROTTLE_FLAG:!0,INIT_IMGWIDTH:0,INIT_IMGHEIGHT:0,TIME_BG:null,TIME_CUT_CENTER:null,_touch_img_relative:[{x:0,y:0}],_flag_cut_touch:!1,_hypotenuse_length:0,_flag_img_endtouch:!1,_flag_bright:!0,_canvas_overflow:!0,_canvas_width:200,_canvas_height:200,origin_x:.5,origin_y:.5,_cut_animation:!1,_img_top:wx.getSystemInfoSync().windowHeight/2,_img_left:wx.getSystemInfoSync().windowWidth/2,watch:{width(b,a){b<a.data.min_width&&a.setData({width:a.data.min_width}),a._computeCutSize()},height(b,a){b<a.data.min_height&&a.setData({height:a.data.min_height}),a._computeCutSize()},angle(b,a){if(a._moveStop(),a.data.limit_move&&a.data.angle%90){a.setData({angle:90*Math.round(a.data.angle/90)});return}},_cut_animation(b,a){clearTimeout(a.data._cut_animation_time),b&&(a.data._cut_animation_time=setTimeout(()=>{a.setData({_cut_animation:!1})},300))},limit_move(b,a){b&&(a.data.angle%90&&a.setData({angle:90*Math.round(a.data.angle/90)}),a._imgMarginDetectionScale(),a.data._canvas_overflow||a._draw())},canvas_top(b,a){a._canvasDetectionPosition()},canvas_left(b,a){a._canvasDetectionPosition()},imgSrc(b,a){a.pushImg()},cut_top(b,a){a._cutDetectionPosition(),a.data.limit_move&&(a.data._canvas_overflow||a._draw())},cut_left(b,a){a._cutDetectionPosition(),a.data.limit_move&&(a.data._canvas_overflow||a._draw())}}},attached(){this.data.info=wx.getSystemInfoSync(),this._watcher(),this.data.INIT_IMGWIDTH=this.data.img_width,this.data.INIT_IMGHEIGHT=this.data.img_height,this.setData({_canvas_height:this.data.height,_canvas_width:this.data.width}),this._initCanvas(),this.data.imgSrc&&(this.data.imgSrc=this.data.imgSrc),this._initImageSize(),this._computeCutSize(),this._cutDetectionPosition(),this._canvasDetectionPosition(),this.triggerEvent("load",{cropper:this})},methods:{upload(){let a=this;wx.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success(b){let c=b.tempFilePaths[0];a.pushImg(c),wx.showLoading({title:"\u52A0\u8F7D\u4E2D..."})}})},getImg(a){this._draw(()=>{wx.canvasToTempFilePath({width:this.data.width*this.data.export_scale,height:Math.round(this.data.height*this.data.export_scale),destWidth:this.data.width*this.data.export_scale,destHeight:Math.round(this.data.height)*this.data.export_scale,fileType:"jpg",quality:this.data.quality,canvasId:this.data.el,success:b=>{a({url:b.tempFilePath,width:this.data.width*this.data.export_scale,height:this.data.height*this.data.export_scale})}},this)})},setTransform(a){if(!a)return;this.data.disable_rotate||this.setData({angle:a.angle?this.data.angle+a.angle:this.data.angle});var b=this.data.scale;a.scale&&(b=(b=(b=this.data.scale+a.scale)<=this.data.min_scale?this.data.min_scale:b)>=this.data.max_scale?this.data.max_scale:b),this.data.scale=b;let c=this.data.cut_left,d=this.data.cut_top;a.cutX&&(this.setData({cut_left:c+a.cutX}),this.data.watch.cut_left(null,this)),a.cutY&&(this.setData({cut_top:d+a.cutY}),this.data.watch.cut_top(null,this)),this.data._img_top=a.y?this.data._img_top+a.y:this.data._img_top,this.data._img_left=a.x?this.data._img_left+a.x:this.data._img_left,this._imgMarginDetectionScale(),this._moveDuring(),this.setData({scale:this.data.scale,_img_top:this.data._img_top,_img_left:this.data._img_left}),this.data._canvas_overflow||this._draw(),this._moveStop()},setCutXY(a,b){this.setData({cut_top:b,cut_left:a})},setCutSize(a,b){this.setData({width:a,height:b}),this._computeCutSize()},setCutCenter(){let a=(this.data.info.windowHeight-this.data.height)*.5,b=(this.data.info.windowWidth-this.data.width)*.5;this.setData({_img_top:this.data._img_top-this.data.cut_top+a,cut_top:a,_img_left:this.data._img_left-this.data.cut_left+b,cut_left:b})},_setCutCenter(){let a=(this.data.info.windowHeight-this.data.height)*.5,b=(this.data.info.windowWidth-this.data.width)*.5;this.setData({cut_top:a,cut_left:b})},setWidth(a){this.setData({width:a}),this._computeCutSize()},setHeight(a){this.setData({height:a}),this._computeCutSize()},setDisableRotate(a){this.data.disable_rotate=a},setLimitMove(a){this.setData({_cut_animation:!0,limit_move:!!a})},imgReset(){this.setData({scale:1,angle:0,_img_top:wx.getSystemInfoSync().windowHeight/2,_img_left:wx.getSystemInfoSync().windowWidth/2})},pushImg(a){if(a){this.setData({imgSrc:a});return}this.data.imgSrc&&wx.getImageInfo({src:this.data.imgSrc,success:a=>{this.data.imageObject=a,-1==this.data.imgSrc.search(/tmp/)&&this.setData({imgSrc:a.path}),this._imgComputeSize(),this.data.limit_move&&this._imgMarginDetectionScale(),this._draw()},fail:a=>{this.setData({imgSrc:""})}})},imageLoad(a){setTimeout(()=>{this.triggerEvent("imageload",this.data.imageObject)})},setScale(a){a&&(this.setData({scale:a}),this.data._canvas_overflow||this._draw())},setAngle(a){a&&(this.setData({_cut_animation:!0,angle:a}),this._imgMarginDetectionScale(),this.data._canvas_overflow||this._draw())},_initCanvas(){this.data.ctx||(this.data.ctx=wx.createCanvasContext("image-cropper",this))},_initImageSize(){if(this.data.INIT_IMGWIDTH&&"string"==typeof this.data.INIT_IMGWIDTH&& -1!=this.data.INIT_IMGWIDTH.indexOf("%")){let a=this.data.INIT_IMGWIDTH.replace("%","");this.data.INIT_IMGWIDTH=this.data.img_width=this.data.info.windowWidth/100*a}if(this.data.INIT_IMGHEIGHT&&"string"==typeof this.data.INIT_IMGHEIGHT&& -1!=this.data.INIT_IMGHEIGHT.indexOf("%")){let b=this.data.img_height.replace("%","");this.data.INIT_IMGHEIGHT=this.data.img_height=this.data.info.windowHeight/100*b}},_cutDetectionPosition(){let a=()=>{this.data.cut_top<0&&this.setData({cut_top:0}),this.data.cut_top>this.data.info.windowHeight-this.data.height&&this.setData({cut_top:this.data.info.windowHeight-this.data.height})},b=()=>{this.data.cut_left<0&&this.setData({cut_left:0}),this.data.cut_left>this.data.info.windowWidth-this.data.width&&this.setData({cut_left:this.data.info.windowWidth-this.data.width})};null==this.data.cut_top&&null==this.data.cut_left?this._setCutCenter():null!=this.data.cut_top&&null!=this.data.cut_left?(a(),b()):null!=this.data.cut_top&&null==this.data.cut_left?(a(),this.setData({cut_left:(this.data.info.windowWidth-this.data.width)/2})):null==this.data.cut_top&&null!=this.data.cut_left&&(b(),this.setData({cut_top:(this.data.info.windowHeight-this.data.height)/2}))},_canvasDetectionPosition(){null==this.data.canvas_top&&null==this.data.canvas_left?(this.data._canvas_overflow=!1,this.setData({canvas_top:-5e3,canvas_left:-5e3})):null!=this.data.canvas_top&&null!=this.data.canvas_left?this.data.canvas_top< -this.data.height||this.data.canvas_top>this.data.info.windowHeight?this.data._canvas_overflow=!0:this.data._canvas_overflow=!1:null!=this.data.canvas_top&&null==this.data.canvas_left?this.setData({canvas_left:0}):null==this.data.canvas_top&&null!=this.data.canvas_left&&(this.setData({canvas_top:0}),this.data.canvas_left< -this.data.width||this.data.canvas_left>this.data.info.windowWidth?this.data._canvas_overflow=!0:this.data._canvas_overflow=!1)},_imgMarginDetectionPosition(a){if(!this.data.limit_move)return;let b=this.data._img_left,c=this.data._img_top;var a=a||this.data.scale;let d=this.data.img_width,e=this.data.img_height;this.data.angle/90%2&&(d=this.data.img_height,e=this.data.img_width),b=this.data.cut_left+d*a/2>=b?b:this.data.cut_left+d*a/2,b=this.data.cut_left+this.data.width-d*a/2<=b?b:this.data.cut_left+this.data.width-d*a/2,c=this.data.cut_top+e*a/2>=c?c:this.data.cut_top+e*a/2,c=this.data.cut_top+this.data.height-e*a/2<=c?c:this.data.cut_top+this.data.height-e*a/2,this.setData({_img_left:b,_img_top:c,scale:a})},_imgMarginDetectionScale(){if(!this.data.limit_move)return;let a=this.data.scale,b=this.data.img_width,c=this.data.img_height;this.data.angle/90%2&&(b=this.data.img_height,c=this.data.img_width),b*a<this.data.width&&(a=this.data.width/b),c*a<this.data.height&&(a=Math.max(a,this.data.height/c)),this._imgMarginDetectionPosition(a)},_setData(b){let c={};for(var a in b)this.data[a]!=b[a]&&(c[a]=b[a]);return this.setData(c),c},_imgComputeSize(){let a=this.data.img_width,b=this.data.img_height;this.data.INIT_IMGHEIGHT||this.data.INIT_IMGWIDTH?this.data.INIT_IMGHEIGHT&&!this.data.INIT_IMGWIDTH?a=this.data.imageObject.width/this.data.imageObject.height*this.data.INIT_IMGHEIGHT:!this.data.INIT_IMGHEIGHT&&this.data.INIT_IMGWIDTH&&(b=this.data.imageObject.height/this.data.imageObject.width*this.data.INIT_IMGWIDTH):(a=this.data.imageObject.width)/(b=this.data.imageObject.height)>this.data.width/this.data.height?(b=this.data.height,a=this.data.imageObject.width/this.data.imageObject.height*b):(a=this.data.width,b=this.data.imageObject.height/this.data.imageObject.width*a),this.setData({img_width:a,img_height:b})},_computeCutSize(){this.data.width>this.data.info.windowWidth?this.setData({width:this.data.info.windowWidth}):this.data.width+this.data.cut_left>this.data.info.windowWidth&&this.setData({cut_left:this.data.info.windowWidth-this.data.cut_left}),this.data.height>this.data.info.windowHeight?this.setData({height:this.data.info.windowHeight}):this.data.height+this.data.cut_top>this.data.info.windowHeight&&this.setData({cut_top:this.data.info.windowHeight-this.data.cut_top}),this.data._canvas_overflow||this._draw()},_start(a){if(this.data._flag_img_endtouch=!1,1==a.touches.length)this.data._touch_img_relative[0]={x:a.touches[0].clientX-this.data._img_left,y:a.touches[0].clientY-this.data._img_top};else{let b=Math.abs(a.touches[0].clientX-a.touches[1].clientX),c=Math.abs(a.touches[0].clientY-a.touches[1].clientY);this.data._touch_img_relative=[{x:a.touches[0].clientX-this.data._img_left,y:a.touches[0].clientY-this.data._img_top},{x:a.touches[1].clientX-this.data._img_left,y:a.touches[1].clientY-this.data._img_top}],this.data._hypotenuse_length=Math.sqrt(Math.pow(b,2)+Math.pow(c,2))}this.data._canvas_overflow||this._draw()},_move_throttle(){if("android"==this.data.info.platform)return clearTimeout(this.data.MOVE_THROTTLE),this.data.MOVE_THROTTLE=setTimeout(()=>{this.data.MOVE_THROTTLE_FLAG=!0},25),this.data.MOVE_THROTTLE_FLAG;this.data.MOVE_THROTTLE_FLAG=!0},_move(a){if(!this.data._flag_img_endtouch&&this.data.MOVE_THROTTLE_FLAG){if(this.data.MOVE_THROTTLE_FLAG=!1,this._move_throttle(),this._moveDuring(),1==a.touches.length){let i=a.touches[0].clientX-this.data._touch_img_relative[0].x,j=a.touches[0].clientY-this.data._touch_img_relative[0].y;this.data._img_left=i,this.data._img_top=j,this._imgMarginDetectionPosition(),this.setData({_img_left:this.data._img_left,_img_top:this.data._img_top})}else{let e=Math.abs(a.touches[0].clientX-a.touches[1].clientX),f=Math.abs(a.touches[0].clientY-a.touches[1].clientY),k=Math.sqrt(Math.pow(e,2)+Math.pow(f,2)),b=this.data.scale*(k/this.data._hypotenuse_length),d=0;b=(b=b<=this.data.min_scale?this.data.min_scale:b)>=this.data.max_scale?this.data.max_scale:b,this.data.scale=b,this._imgMarginDetectionScale();let c=[{x:a.touches[0].clientX-this.data._img_left,y:a.touches[0].clientY-this.data._img_top},{x:a.touches[1].clientX-this.data._img_left,y:a.touches[1].clientY-this.data._img_top}];if(!this.data.disable_rotate){let l=180/Math.PI*Math.atan2(c[0].y,c[0].x),m=180/Math.PI*Math.atan2(this.data._touch_img_relative[0].y,this.data._touch_img_relative[0].x),n=180/Math.PI*Math.atan2(c[1].y,c[1].x),o=180/Math.PI*Math.atan2(this.data._touch_img_relative[1].y,this.data._touch_img_relative[1].x),g=l-m,h=n-o;0!=g?d=g:0!=h&&(d=h)}this.data._touch_img_relative=c,this.data._hypotenuse_length=Math.sqrt(Math.pow(e,2)+Math.pow(f,2)),this.setData({angle:this.data.angle+d,scale:this.data.scale})}this.data._canvas_overflow||this._draw()}},_end(a){this.data._flag_img_endtouch=!0,this._moveStop()},_click(a){if(!this.data.imgSrc){this.upload();return}this._draw(()=>{let b=a.detail?a.detail.x:a.touches[0].clientX,c=a.detail?a.detail.y:a.touches[0].clientY;b>=this.data.cut_left&&b<=this.data.cut_left+this.data.width&&c>=this.data.cut_top&&c<=this.data.cut_top+this.data.height&&wx.canvasToTempFilePath({width:this.data.width*this.data.export_scale,height:Math.round(this.data.height*this.data.export_scale),destWidth:this.data.width*this.data.export_scale,destHeight:Math.round(this.data.height)*this.data.export_scale,fileType:"jpg",quality:this.data.quality,canvasId:this.data.el,success:a=>{this.triggerEvent("tapcut",{url:a.tempFilePath,width:this.data.width*this.data.export_scale,height:this.data.height*this.data.export_scale})}},this)})},_draw(b){if(!this.data.imgSrc)return;let a=()=>{let a=this.data.img_width*this.data.scale*this.data.export_scale,c=this.data.img_height*this.data.scale*this.data.export_scale;var d=this.data._img_left-this.data.cut_left,e=this.data._img_top-this.data.cut_top;this.data.ctx.translate(d*this.data.export_scale,e*this.data.export_scale),this.data.ctx.rotate(this.data.angle*Math.PI/180),this.data.ctx.drawImage(this.data.imgSrc,-a/2,-c/2,a,c),this.data.ctx.draw(!1,()=>{b&&b()})};this.data.ctx.width!=this.data.width||this.data.ctx.height!=this.data.height?this.setData({_canvas_height:this.data.height,_canvas_width:this.data.width},()=>{setTimeout(()=>{a()},40)}):a()},_cutTouchMove(c){if(this.data._flag_cut_touch&&this.data.MOVE_THROTTLE_FLAG){if(this.data.disable_ratio&&(this.data.disable_width||this.data.disable_height))return;this.data.MOVE_THROTTLE_FLAG=!1,this._move_throttle();let a=this.data.width,b=this.data.height,d=this.data.cut_top,e=this.data.cut_left,g=()=>{a=a<=this.data.max_width?a>=this.data.min_width?a:this.data.min_width:this.data.max_width,b=b<=this.data.max_height?b>=this.data.min_height?b:this.data.min_height:this.data.max_height},f=()=>(a>this.data.max_width||a<this.data.min_width||b>this.data.max_height||b<this.data.min_height)&&this.data.disable_ratio?(g(),!1):(g(),!0);switch(b=this.data.CUT_START.height+(this.data.CUT_START.corner>1&&this.data.CUT_START.corner<4?1:-1)*(this.data.CUT_START.y-c.touches[0].clientY),this.data.CUT_START.corner){case 1:if(a=this.data.CUT_START.width+this.data.CUT_START.x-c.touches[0].clientX,this.data.disable_ratio&&(b=a/(this.data.width/this.data.height)),!f())return;e=this.data.CUT_START.cut_left-(a-this.data.CUT_START.width);break;case 2:if(a=this.data.CUT_START.width+this.data.CUT_START.x-c.touches[0].clientX,this.data.disable_ratio&&(b=a/(this.data.width/this.data.height)),!f())return;d=this.data.CUT_START.cut_top-(b-this.data.CUT_START.height),e=this.data.CUT_START.cut_left-(a-this.data.CUT_START.width);break;case 3:if(a=this.data.CUT_START.width-this.data.CUT_START.x+c.touches[0].clientX,this.data.disable_ratio&&(b=a/(this.data.width/this.data.height)),!f())return;d=this.data.CUT_START.cut_top-(b-this.data.CUT_START.height);break;case 4:if(a=this.data.CUT_START.width-this.data.CUT_START.x+c.touches[0].clientX,this.data.disable_ratio&&(b=a/(this.data.width/this.data.height)),!f())return}this.data.disable_width||this.data.disable_height?this.data.disable_width?this.data.disable_height||this.setData({height:b,cut_top:d}):this.setData({width:a,cut_left:e}):this.setData({width:a,cut_left:e,height:b,cut_top:d}),this._imgMarginDetectionScale()}},_cutTouchStart(c){let a=c.touches[0].clientX,b=c.touches[0].clientY,d=this.data.cut_top+this.data.height-30,e=this.data.cut_top+this.data.height+20,f=this.data.cut_left+this.data.width-30,g=this.data.cut_left+this.data.width+30,h=this.data.cut_top-30,i=this.data.cut_top+30,j=this.data.cut_left+this.data.width-30,k=this.data.cut_left+this.data.width+30,l=this.data.cut_top-30,m=this.data.cut_top+30,n=this.data.cut_left-30,o=this.data.cut_left+30,p=this.data.cut_top+this.data.height-30,q=this.data.cut_top+this.data.height+30,r=this.data.cut_left-30,s=this.data.cut_left+30;a>f&&a<g&&b>d&&b<e?(this._moveDuring(),this.data._flag_cut_touch=!0,this.data._flag_img_endtouch=!0,this.data.CUT_START={width:this.data.width,height:this.data.height,x:a,y:b,corner:4}):a>j&&a<k&&b>h&&b<i?(this._moveDuring(),this.data._flag_cut_touch=!0,this.data._flag_img_endtouch=!0,this.data.CUT_START={width:this.data.width,height:this.data.height,x:a,y:b,cut_top:this.data.cut_top,cut_left:this.data.cut_left,corner:3}):a>n&&a<o&&b>l&&b<m?(this._moveDuring(),this.data._flag_cut_touch=!0,this.data._flag_img_endtouch=!0,this.data.CUT_START={width:this.data.width,height:this.data.height,cut_top:this.data.cut_top,cut_left:this.data.cut_left,x:a,y:b,corner:2}):a>r&&a<s&&b>p&&b<q&&(this._moveDuring(),this.data._flag_cut_touch=!0,this.data._flag_img_endtouch=!0,this.data.CUT_START={width:this.data.width,height:this.data.height,cut_top:this.data.cut_top,cut_left:this.data.cut_left,x:a,y:b,corner:1})},_cutTouchEnd(a){this._moveStop(),this.data._flag_cut_touch=!1},_moveStop(){clearTimeout(this.data.TIME_CUT_CENTER),this.data.TIME_CUT_CENTER=setTimeout(()=>{this.data._cut_animation||this.setData({_cut_animation:!0}),this.setCutCenter()},1e3),clearTimeout(this.data.TIME_BG),this.data.TIME_BG=setTimeout(()=>{this.data._flag_bright&&this.setData({_flag_bright:!1})},2e3)},_moveDuring(){clearTimeout(this.data.TIME_CUT_CENTER),clearTimeout(this.data.TIME_BG),this.data._flag_bright||this.setData({_flag_bright:!0})},_watcher(){Object.keys(this.data).forEach(a=>{this._observe(this.data,a,this.data.watch[a])})},_observe(a,b,c){var d=a[b];Object.defineProperty(a,b,{configurable:!0,enumerable:!0,set:a=>{d=a,c&&c(d,this)},get(){if(d&& -1!="_img_top|img_left||width|height|min_width|max_width|min_height|max_height|export_scale|cut_top|cut_left|canvas_top|canvas_left|img_width|img_height|scale|angle|min_scale|max_scale".indexOf(b)){let a=parseFloat(parseFloat(d).toFixed(3));return"string"==typeof d&& -1!=d.indexOf("%")&&(a+="%"),a}return d}})},_preventTouchMove(){}}})
